<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-US">
<head profile="http://gmpg.org/xfn/11">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<title>Fuel Crash Course</title>
	<link rel='stylesheet' type='text/css' media='screen' href='assets/css/screen.css' />
	<link rel="stylesheet" href="assets/css/print.css" type="text/css" media="print" />

	<!-- Oswald Google Font -->
	<link href='http://fonts.googleapis.com/css?family=Oswald' rel='stylesheet' type='text/css' />

	<!-- Special Theme css -->
	<link rel='stylesheet' type='text/css' media='screen' href='assets/css/fuelphptutorial.css' />

	<script type='text/javascript' src='assets/js/jquery-1.3.2.min.js'></script>

	<meta id="syntaxhighlighteranchor" name="syntaxhighlighter-version" content="3.1.3" />
	<script type="text/javascript">
	$(document).ready(function()
	{

		var OSName="linux";
		if (navigator.appVersion.indexOf("Win")!=-1) OSName = "windows";
		showHide(OSName)

		console.log('Your OS: '+OSName);


		$(".show-windows").click(function() {
			scrollTo($(this), 'windows');
		});

		$(".show-linux").click(function() {
			scrollTo($(this), 'linux');
		});

		$('.expando-button').click(function(){
			var content = $(this).next('.expando-content');
			$(this).find('.click_to_expand').text(content.is(':visible') ? '(click to show)' : '(click to hide)');
			content.slideToggle(600);
		});

	});

	function scrollTo($element, showWhat)
	{
		// get the screen position
		var scrollTop     = $(window).scrollTop();
		var elementOffset = $element.offset().top;

		showHide(showWhat);

		// remeasure location
		var elementOffset2 = $element.offset().top;

		// move to new location to keep the button in the same place thanks @zberry
		$('html, body').scrollTop(scrollTop + (elementOffset2 - elementOffset))
	}

	function showHide(showWhat){
		// switch the windows/linux visibility
		$('body').removeClass('os-show-windows').removeClass('os-show-linux').addClass('os-show-'+showWhat);
		$(".show-linux").removeClass('selected')
		$(".show-windows").removeClass('selected');
		$(".show-"+showWhat).addClass('selected');
	}

	(function(){
		var syntax_highlighter_theme_css = document.createElement('link');
		var syntax_highlighter_theme_css_link = "assets/css/sh_theme_override.css";
		if ( syntax_highlighter_theme_css.setAttribute )
		{
			syntax_highlighter_theme_css.setAttribute( "rel", "stylesheet" );
			syntax_highlighter_theme_css.setAttribute( "type", "text/css" );
			syntax_highlighter_theme_css.setAttribute( "href", syntax_highlighter_theme_css_link );
		}
		document.getElementsByTagName("head")[0].appendChild( syntax_highlighter_theme_css);
	})();
	</script>

</head>

<body class="os-show-linux">

	<div id="page">
		<div class="head">
			<h1 id="fuel-crash-course-part-1-creating-a-messaging-system" class="single_post" >Fuel Crash Course </h1>
			<div class="icon-fuel-guy"><img src="assets/images/hangmanguy_fuel.png" alt="Man holding gas can and lit match" /></div>
		</div>

		<div class="post">
			<p class="sub_title">An introduction to the Fuel PHP framework</p>
			<div class="fuel-table-of-contents">
				<p>Table of contents:</p>
				<ol>
					<li><a href="#part1">Part 1 – Creating a Messaging System</a></li>
					<li><a href="#part2">Part 2 – Adding Comments</a></li>
					<li><a href="#part3">Part 3 – Adding a Login System</a></li>
				</ol>
			</div>

			<h3>Before You Get Started</h3>

			<p>This tutorial is here to introduce you to the FuelPHP framework by walking you through the creation of a simple messaging app.</p>

			<h4>Choose &#8211; Windows or Linux/OSX</h4>

			<p>
				<div class="os-switch">
					<div class="os-button show-linux">Linux/OSX Instructions</div> or <div class="os-button show-windows">Windows Instructions</div>
				</div>
			</p>

			<h4>Requirements</h4>

			<div class="os-switch">
				<div class="windows">
					<p>First and foremost, here's what you're going to need on Windows:</p>
					<ol>
						<li><a href="http://fuelphp.com">Fuel PHP framework</a> (we're using v1.7.2)</li>
						<li><a href="http://www.apachefriends.org/en/xampp.html">XAMPP</a> (if you're having trouble installing this, <a href="http://keito.me/tutorials/xampp">go here for a tutorial</a>)</li>
						<li><a href="http://www.nextofwindows.com/how-to-addedit-environment-variables-in-windows-7/">PHP Environment Variables Configured in Windows</a> (for command line executions)</li>
						<li>phpMyAdmin (it comes with XAMPP)</li>
						<li>A basic understanding of the <a href="http://php-html.net/tutorials/model-view-controller-in-php/">Model-View-Controller (MVC) pattern</a>.</li>
						<li>At least a basic understanding of <a href="http://try.github.io/levels/1/challenges/1">Git</a> and version control systems.</li>
					</ol>
				</div>
				<div class="linux">
					<p>First and foremost, here's what you're going to need on Linux/OSX:</p>
					<ol>
						<li><a href="http://fuelphp.com">Fuel PHP framework</a> (we're using v1.7.2)</li>
						<li><a href="http://www.apachefriends.org/en/xampp.html">PHP</a> (version 5.5 or greater)
						<li>< ahref="https://www.phpmyadmin.net/downloads/">phpMyAdmin</a> (we are going to run this without apache)</li>
						<li>A basic understanding of the <a href="http://php-html.net/tutorials/model-view-controller-in-php/">Model-View-Controller (MVC) pattern</a>.</li>
						<li>At least a basic understanding of <a href="http://try.github.io/levels/1/challenges/1">Git</a> and version control systems.</li>
					</ol>
				</div>
				<div class="mini-os-switch">
					Showing Instructions for: <div class="os-button show-linux">Linux/OSX</div> or <div class="os-button show-windows">Windows</div>
				</div>
			</div>

			<p>Keep in mind that the completed source code for this tutorial is available from the <a href="https://github.com/UCF/fuelphp-crash-course">Fuel Crash Course GitHub repository</a>.  Simply clone our repo and make sure you initialize all the sub-repos using <code>git submodule update --init</code></p>

			<h3 id="part1">Part 1 &#8211; Creating a Messaging System</h3>

			<h4 id="Basic_FuelPhp_Setup">Basic FuelPhp Setup</h4>

			<p>Create a folder called &#8220;fuel_intro&#8221; in the htdocs folder of xampp.</p>

			<p>Next, open up command line, navigate to that folder, and type in the following: <code>git clone https://github.com/fuel/fuel.git .</code> Don't forget the period at the end, that will clone the files into the directory you are currently in.</p>

			<p>Now that the files have been clones, you have to update all of the <a href="https://getcomposer.org/doc/00-intro.md#introduction">PHP dependencies</a> by typing in the following command:</p>

			<p><code>php composer.phar update</code></p>

			<h4 id="Checking_Your_Work">Checking Your Work</h4>

			<p>In your browser, navigate to <a href="http://localhost/fuel_intro/public">http://localhost/fuel_intro/public</a> and you should see the &#8220;successful install&#8221; page below from Fuel.</p>

			<p><img src="assets/images/fuelsuccess.png" alt="Screenshot showing successful Fuel PHP install." /></p>
			<div class="expando-button"><h5><span class="title">Troubleshooting</span>: When file permissions cause fuelphp errors <span class="click_to_expand">(click to show)</span></h5></div>
			<div class="expando-content">
				<div class="os-switch">
					<div class="windows">
						<h5>Troubleshooting</h5>
						<p>If your page looks like the following screenshot, this means that Fuel does not have write permissions for the listed files, which it needs. If you do not receive any errors, feel free to skip over this next step, as it does not apply to you.</p>
						<p><img src="assets/images/error01.png" alt="Screenshot showing a permissions error for fuel setup." /></p>
						<p>Do the following to give the directories and files the proper permissions.</p>
						<p><img src="assets/images/permissions.jpg" alt="Screenshot of how to handle the error in the command prompt. First Command: cd:/xampp/htdocs/fuel_intro, Second Command: CACLS fuel/app/config /e /p %username%:F, Third Command: CACLS fuel/app/logs /e /p %username%:F" /></p>
						<p><code>%username%</code> is a special kind of variable in Windows which holds the name of the current logged in user and <code>CACLS</code> is a Windows function which allows you to change permissions on files and folders based on the user.</p>
						<p>I would not suggest using these settings in a production environment, but for our purposes they work just fine. To learn more about Windows file permissions, you can read <a href="http://www.cyberciti.biz/tips/windows-change-access-permissions-from-the-command-line.html" target="_blank">Windows File Permissions</a>.</p>
						<p>You could also type the following command into the command line for more help. <code>cacls /?</code></p>
					</div>

					<div class="linux">
						<h5>Troubleshooting</h5>
						<p>If, at any point in this tutorial, you run into something that resembles the following page, you may need to tweak your file and directory permissions using the <code>chmod</code> terminal command in order to have Fuel properly display a (meaningful) error message. </p>
						<p><img src="assets/images/linux_permissions_01.png" alt="Screenshot showing incorrect permission setting." /></p>
						<p>You'll need to recursively change the access to Fuel's <code>logs</code> directory as well as its subdirectories and files to read, write, and execute for all users. To do this, change directory in the terminal to <code>fuel/app</code> and enter the following command:</p>
						<p><code>sudo chmod -R 777 logs</code>.</p>
						<p><img src="assets/images/linux_permissions_02.png" alt="Screenshot showing incorrect permission setting." /></p>
						<p>If you examine the directory using the <code>ls -la</code> command, you'll notice that all users have now been given <code>rwx</code> permissions. </p>
					</div>
					<div class="mini-os-switch">
						Showing Instructions for: <div class="os-button show-linux">Linux/OSX</div> or <div class="os-button show-windows">Windows</div>
					</div>
				</div>
			</div>

			<h4>Config It Up</h4>
			<p>For this tutorial we're going to be using an <a href="http://en.wikipedia.org/wiki/Object-relational_mapping">orm package</a>, included in your install of Fuel. Head over to <code>/fuel/app/config/config.php</code> and uncomment the &#8220;always_load&#8221; array. Then uncomment the &#8220;packages&#8221; array and the &#8220;orm&#8221; package:</p>
			<pre class="brush: php; first-line: 258; highlight:[261,274,275,276,312] notranslate" title="">
				/**************************************************************************/
				/* Always Load                                                            */
				/**************************************************************************/
				'always_load'  =&gt; array(

				/**
				* These packages are loaded on Fuel's startup.
				* You can specify them in the following manner:
				*
				* array('auth'); // This will assume the packages are in PKGPATH
				*
				* // Use this format to specify the path to the package explicitly
				* array(
				*     array('auth'	=&gt; PKGPATH.'auth/')
				* );
				*/
				'packages'  =&gt; array(
					'orm',
				),

				/**
				* These modules are always loaded on Fuel's startup. You can specify them
				* in the following manner:
				*
				* array('module_name');
				*
				* A path must be set in module_paths for this to work.
				*/
				// 'modules'  =&gt; array(),

				/**
				* Classes to autoload & initialize even when not used
				*/
				// 'classes'  =&gt; array(),

				/**
				* Configs to autoload
				*
				* Examples: if you want to load 'session' config into a group 'session' you only have to
				* add 'session'. If you want to add it to another group (example: 'auth') you have to
				* add it like 'session' => 'auth'.
				* If you don't want the config in a group use null as groupname.
				*/
				// 'config'  =&gt; array(),

				/**
				* Language files to autoload
				*
				* Examples: if you want to load 'validation' lang into a group 'validation' you only have to
				* add 'validation'. If you want to add it to another group (example: 'forms') you have to
				* add it like 'validation' => 'forms'.
				* If you don't want the lang in a group use null as groupname.
				*/
				// 'language'  =&gt; array(),
				),
			</pre>
			<p>While you're in this file, there's another Fuel preset you'll want to set. That'd be the default timezone. Fuel requires that you set a default timezone for it to work. Fuel uses PHP's built-in time zones, so check out <a href="http://www.php.net/manual/en/timezones.php">PHP's list of supported timezones</a> and find one that corresponds to yours.<br/><br/>For simplicity's sake, this tutorial will use America/New_York.</p>
			<pre class="brush: php; first-line: 90; highlight:[96,97] notranslate" title="">
				/**
				* DateTime settings
				*
				* server_gmt_offset	in seconds the server offset from gmt timestamp when time() is used
				* default_timezone		optional, if you want to change the server's default timezone
				*/
				'server_gmt_offset'  =&gt 0,
				'default_timezone'   =&gt 'America/New_York',
			</pre>
			<p>After doing that, go to phpmyadmin (<a href="http://localhost/phpmyadmin">http://localhost/phpmyadmin</a>) and create a database called &#8220;fuel_intro&#8221;. No need to create any tables now, we'll use Fuel to setup our tables.</p>
			<p><img src="assets/images/gettin_configged_up_02a.jpg" alt="Screenshot showing the creation of a database from phpmyadmin." /></p>

			<p>We renamed the database to "fuel_intro" and changed the password to the default password for our mysql install. Aside from that, we left everything else alone since the defaults will work fine.</p>
			<p>Now, make these changes in the db configuration in Fuel's development environment: <code>fuel/app/config/development/db.php</code></p>

			<pre class="brush: php; first-line: 6; highlight:[9,10,11] notranslate" title="" >
				return array(
					'default' => array(
						'connection'  => array(
							'dsn'        => 'mysql:host=localhost;dbname=fuel_intro',
							'username'   => 'root',
							'password'   => '',
						),
					),
				);
			</pre>

			<h4 id="Oil_Slick">Oil Slick</h4>
			<p>Fuel has a cool command line utility called Oil that lets you set up a lot of your controllers and tables automatically.</p>
			<p>Bring up Command Prompt, type in the file path of your Fuel installation, and then run <code>php oil</code>. You should see a bit of oil usage documentation.</p>

			<div class="os-switch">
				<div class="windows">
					<p><img src="assets/images/oil_slick_02.jpg" alt="Running php oil. Command 1: cd c:/xampp/htdocs/fuel_intro, Command 2: php oil" /></p>
				</div>
				<div class="linux">
					<p><img src="assets/images/oil_slick_02.png" alt="Running php oil. Command 1: cd c:/xampp/htdocs/fuel_intro, Command 2: php oil" /></p>
				</div>
				<div class="mini-os-switch">
					Showing Instructions for: <div class="os-button show-linux">Linux/OSX</div> or <div class="os-button show-windows">Windows</div>
				</div>
			</div>

			<p>Seeing this means that Oil is successfully installed and working! Now let's get to business.</p>
			<h5 id="Every_Building_Needs_A_Scaffold">Every Building Needs a Scaffold</h5>
			<p>Scaffolding in fuel allows you to quickly create a related controller, model (using ORM), and view for manipulating information.</p>
			<p>What we want to end up with after creating the scaffold is a table with the following fields:</p>
			<p><img src="assets/images/every_building_needs_a_scaffold_01a.jpg" alt="Screenshot of field names." /></p>
			<p>The &#8216;id', &#8216;created_at', and &#8216;updated_at' columns are made automatically, so we only have to tell oil to make the 'name' and 'message' fields. Just feed your command prompt the following:</p>
			<p><code>php oil generate scaffold messages name:string message:text</code></p>

			<div class="os-switch">
				<div class="windows">
					<p><img src="assets/images/every_building_needs_a_scaffold_02.jpg" alt="Running php scaffold for messages: php oil generate scaffold messages name:string message:text." /></p>
				</div>
				<div class="linux">
					<p><img src="assets/images/every_building_needs_a_scaffold_02.png" alt="Running php scaffold for messages: php oil generate scaffold messages name:string message:text." /></p>
				</div>
				<div class="mini-os-switch">
					Showing Instructions for: <div class="os-button show-linux">Linux/OSX</div> or <div class="os-button show-windows">Windows</div>
				</div>
			</div>

			<p>The only weird thing about this is that the &#8220;string&#8221; type for the name is a shortcut that is really varchar[255].</p>
			<p>If you look at your document tree, you can see that the controller, model, and view were created and populated with default content.</p>
			<p>If you look at your database, you'll notice that no table has been created. That's because we need to migrate the database.</p>
			<h6 id="Migra-wha">Migra-wha?</h6>
			<p>A migration is like a version control scheme for your database. If you open up the file <code>/fuel/app/migrations/001_create_messages.php</code> you can see what is going to be generated when the migration runs. Checking the file before you run the migration is a good idea, at least to check for typos.</p>
			<pre class="brush: php; notranslate" title="">
				&lt;?php

				namespace Fuel\Migrations;

				class Create_messages
				{
					public function up()
					{
						\DBUtil::create_table('messages', array(
							'id' => array('constraint' => 11, 'type' => 'int', 'auto_increment' => true),
							'name' => array('constraint' => 255, 'type' => 'varchar'),
							'message' => array('type' => 'text'),
							'created_at' => array('constraint' => 11, 'type' => 'int'),
							'updated_at' => array('constraint' => 11, 'type' => 'int'),

						), array('id'));
					}
					public function down()
					{
						\DBUtil::drop_table('messages');
					}
				}
			</pre>
			<p>Since we know what the migration is going to create, go ahead and run it. That'll be:</p>
			<p><code>php oil refine migrate</code></p>

			<div class="os-switch">
				<div class="windows">
					<p><img src="assets/images/Migra_wha_01.jpg" alt="Running php migrate for scaffold: php oil refine migrate." /></p>
				</div>
				<div class="linux">
					<p><img src="assets/images/Migra_wha_01.png" alt="Running php migrate for scaffold: php oil refine migrate." /></p>
				</div>
				<div class="mini-os-switch">
					Showing Instructions for: <div class="os-button show-linux">Linux/OSX</div> or <div class="os-button show-windows">Windows</div>
				</div>
			</div>

			<p>Quick Note: If you encounter errors migrating with oil, you may need to change this dp.php file to read <code>'mysql:host=127.0.0.1;dbname=fuel_intro'</code>.</p>

			<p>Now the table has been created, and you can add messages to it! Take a look at your database, you should see something like <a href="#Every_Building_Needs_A_Scaffold">the screenshot from before</a>.</p>

			<h4 id="Prettying_Up_The_Code">Prettying Up The Code</h4>
			<p>Navigate to &#8220;<a href="http://localhost/fuel_intro/public/messages">http://localhost/fuel_intro/public/messages</a>&#8221; and add a message.</p>

			<div class="os-switch">
				<div class="windows">
				</div>
				<div class="linux">
					<div class="expando-button"><h5><span class="title">Troubleshooting</span>: running into a "not found" page <span class="click_to_expand">(click to show)</span></h5></div>
					<div class="expando-content">
						<p>If you have a LAMP package and you're recieving a &#8220;Not Found&#8221; page when attempting to access messages, you may not have the proper Apache settings enabled. Navigate to <code>/etc/apache2/sites-available</code>, open the <code>default</code> file, and change the first two <code>AllowOverride</code> permissions to <code>All</code>.</p>
						<p><img src="assets/images/linux_troubleshooting_01.png" /></p>
						<p>When you're finished editing, you'll need to give your terminal the following command to enable <code>mod_rewrite</code>: </p>
						<p><code>sudo a2enmod rewrite</code></p>
						<p>Restart apache using <code>sudo service apache2 restart</code> and reload your page.</p>
					</div>
				</div>
			</div>

			<p>If you see the following error, copy and paste the code into a new php file called crypt.php at <code>/fuel/app/config</code>.</p>
			<p><img src="assets/images/cryptoerror1.7.jpg" alt="Image displaying an error message for lack of read write access to a non existant crypt.php file"/></p>
			<p>If you look at the message, you'll notice that all the layout is done using a table, so take a minute to make the code <a href="http://en.wikipedia.org/wiki/Semantic_HTML">semantic</a>.</p>
			<p>Go into <code>/fuel/app/views/messages/index.php</code> and change the following table into an unordered list:</p>

			<div class="expando-button"><h5><span class="title">Check it out</span>: See the messages view before changes <span class="click_to_expand">(click to show)</span></h5></div>
			<div class="expando-content">
				<div id="before_box">
					<pre class="brush: php; highlight:[4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26] notranslate" title="">
						&lt;h2&gt;Listing &lt;span class='muted'&gt;Messages&lt;/span&gt;&lt;/h2&gt;
						&lt;br&gt;
						&lt;?php if ($messages): ?&gt;
						&lt;table class=&quot;table table-striped&quot;&gt;
							&lt;thead&gt;
								&lt;tr&gt;
									&lt;th&gt;Name&lt;/th&gt;
									&lt;th&gt;Message&lt;/th&gt;
									&lt;th&gt;&amp;nbsp;&lt;/th&gt;
								&lt;/tr&gt;
							&lt;/thead&gt;
							&lt;tbody&gt;
						&lt;?php foreach ($messages as $item): ?&gt;		&lt;tr&gt;

									&lt;td&gt;&lt;?php echo $item-&gt;name; ?&gt;&lt;/td&gt;
									&lt;td&gt;&lt;?php echo $item-&gt;message; ?&gt;&lt;/td&gt;
									&lt;td&gt;
										&lt;div class=&quot;btn-toolbar&quot;&gt;
											&lt;div class=&quot;btn-group&quot;&gt;
												&lt;?php echo Html::anchor('messages/view/'.$item-&gt;id, '&lt;i class=&quot;icon-eye-open&quot;&gt;&lt;/i&gt; View', array('class' =&gt; 'btn btn-small')); ?&gt;						&lt;?php echo Html::anchor('messages/edit/'.$item-&gt;id, '&lt;i class=&quot;icon-wrench&quot;&gt;&lt;/i&gt; Edit', array('class' =&gt; 'btn btn-small')); ?&gt;						&lt;?php echo Html::anchor('messages/delete/'.$item-&gt;id, '&lt;i class=&quot;icon-trash icon-white&quot;&gt;&lt;/i&gt; Delete', array('class' =&gt; 'btn btn-small btn-danger', 'onclick' =&gt; &quot;return confirm('Are you sure?')&quot;)); ?&gt;					&lt;/div&gt;
										&lt;/div&gt;

									&lt;/td&gt;
								&lt;/tr&gt;
						&lt;?php endforeach; ?&gt;	&lt;/tbody&gt;
						&lt;/table&gt;

						&lt;?php else: ?&gt;
						&lt;p&gt;No Messages.&lt;/p&gt;

						&lt;?php endif; ?&gt;&lt;p&gt;
							&lt;?php echo Html::anchor('messages/create', 'Add new Message', array('class' =&gt; 'btn btn-success')); ?&gt;

						&lt;/p&gt;
					</pre>
				</div>
			</div>

			<p><strong>After:</strong></p>
			<pre class="brush: php; highlight:[4,5,6,7,8,9,10,11,12,13,14,15] notranslate" title="">
				&lt;h2&gt;Listing &lt;span class='muted'&gt;Messages&lt;/span&gt;&lt;/h2&gt;
				&lt;br&gt;
				&lt;?php if ($messages): ?&gt;
					&lt;ul&gt;
						&lt;?php foreach ($messages as $message): ?&gt;
							&lt;li&gt;&lt;?php echo $message-&gt;name; ?&gt;
								&lt;ul&gt;
									&lt;li&gt;&lt;?php echo $message-&gt;message; ?&gt;&lt;/li&gt;
									&lt;li&gt;&lt;?php echo Html::anchor('messages/view/'.$message-&gt;id, 'View'); ?&gt;&lt;/li&gt;
									&lt;li&gt;&lt;?php echo Html::anchor('messages/edit/'.$message-&gt;id, 'Edit'); ?&gt;&lt;/li&gt;
									&lt;li&gt;&lt;?php echo Html::anchor('messages/delete/'.$message-&gt;id, 'Delete', array('onclick' =&gt; &quot;return confirm('Are you sure?')&quot;)); ?&gt;&lt;/li&gt;
								&lt;/ul&gt;
							&lt;/li&gt;
						&lt;?php endforeach; ?&gt;
					&lt;/ul&gt;

				&lt;?php else: ?&gt;
					&lt;p&gt;No Messages.&lt;/p&gt;
				&lt;?php endif; ?&gt;
				&lt;p&gt;
					&lt;?php echo Html::anchor('messages/create', 'Add new Message', array('class' =&gt; 'btn btn-success')); ?&gt;
				&lt;/p&gt;
			</pre>
			<p>Now your code is more semantic, if not more understandable (If you don't like the bullets or the list view, <a href="http://css.maxdesign.com.au/listutorial/horizontal_introduction.htm">you can take them away using CSS</a>).</p>

			<h5 id="New_Landing_Page">New Landing Page</h5>
			<p>Remember the successful install page you visited immediately after installing fuel? What you were seeing on that page comes from a view as well. Through routing, fuel can redirect the browser to display views outside of the default structure. These routing directions are stored in <code>/fuel/app/config/routes.php</code>.</p>
			<p>By default there are two routes: the landing page and the 404 page.</p>
			<pre class="brush: php; notranslate" title="">
				&lt;?php
				return array(
					'_root_'  => 'welcome/index',  // The default route
					'_404_'   => 'welcome/404',    // The main 404 route

					'hello(/:name)?' => array('welcome/hello', 'name' => 'hello'),
				);
			</pre>
			<p>You need to have Fuel redirect the browser to the messages view when going to <a href="http://localhost/fuel_intro/public">http://localhost/fuel_intro/public</a> instead of the successful install page. To do that, simply edit the value for the _root_ key like so:</p>
			<pre class="brush: php; highlight:[3] notranslate" title="">
				&lt;?php
				return array(
					'_root_'  => 'messages/index',  // The default route
					'_404_'   => 'welcome/404',    // The main 404 route

					'hello(/:name)?' => array('welcome/hello', 'name' => 'hello'),
				);
			</pre>

			<!--  PART 2  -->
			<hr>

			<h3 id="part2">Part 2 &#8211; Adding Comments</h3>

			<h4 id="New_Comments">New Comments</h4>

			<p>Now that we have semantic messages, we need to add a way for users to add comments to those messages.</p>

			<p>We <em>could</em> use a scaffold again to create everything necessary for comments, but let's do everything that the scaffolding command does by hand. This will give you an idea as to just how powerful oil commands are.</p>

			<p>The first step is to create our controllers and views for the comments. We will be using oil's generate command again to do this. Let's watch:</p>
			<p><code>php oil generate controller comments edit create</code></p>

			<div class="os-switch">
				<div class="windows">
					<p><img src="assets/images/new_comments_01.jpg" alt="Running php generate for comments: php oil generate controller comments edit create." /></p>
				</div>
				<div class="linux">
					<p><img src="assets/images/new_comments_01.png" alt="Running php generate for comments: php oil generate controller comments edit create." /></p>
				</div>
				<div class="mini-os-switch">
					Showing Instructions for: <div class="os-button show-linux">Linux/OSX</div> or <div class="os-button show-windows">Windows</div>
				</div>
			</div>

			<p>As you can see, a controller was generated called &#8220;comments&#8221; with the actions create and edit. Two views were also created, both associated with the comments controller (edit.php and create.php).</p>
			<p>Open the controller at <code>fuel/app/classes/controller/comments.php</code> and see what was made.</p>

			<h5 id="Controlling_the_Power">Controlling the Power</h5>
			<p>The comments controller should look like this:</p>
			<pre class="brush: php; notranslate" title="">
				&lt;?php

				class Controller_Comments extends Controller_Template
				{

					public function action_edit()
					{
						$data["subnav"] = array('edit'=> 'active');
						$this->template->title = 'Comments &amp;raquo; Edit';
						$this->template->content = View::forge('comments/edit', $data);
					}

					public function action_create()
					{
						$data["subnav"] = array('create'=> 'active');
						$this->template->title = 'Comments &amp;raquo; Create';
						$this->template->content = View::forge('comments/create', $data);
					}

				}
			</pre>

			<h6 id="Defaults">Defaults</h6>
			<p>The default class name for the controller is Controller_NAME, and methods accessible through the url are action_NAME. So if you're making your own methods or controllers, you should follow the conventions that are set forth in this file. </p>
			<p>Take careful note that the class ought to read "Controller_Comments", rather than the default "Controller_Comment". Older versions of fuel will autocorrect the name and make it singular.</p>

			<p>Now, back in your action_create function, we need to make a few changes to prepare for the views we are about to build:</p>
		  <pre class="brush: php; first-line: 12; highlight:[16] notranslate" title="">
				public function action_create()
				{
					$data["subnav"] = array('create'=> 'active');
					$this->template->title = 'Comments &raquo; Create';
					$data['form'] = View::forge('comments/_form');
					$this->template->content = View::forge('comments/create', $data);
				}
			</pre>

			<p>We loaded the form we're about to build into the <code>$data</code> array with the key 'form'. This will be accessible in our view as <code>$form</code>.</p>

			<h6 id="Form_Templates">Form Templates</h6>

			<p>If you look at the Messages views (/fuel/app/views/messages/), you will see a file called &#8220;_form.php&#8221;. This is a form template for messages that gets called in the messages views and  should be recreated for the comments views as well.</p>
			<p>Go ahead and create a new file called<code>/fuel/app/views/comments/_form.php</code>.</p>
			<p>Since this is a form template, you're going to start the file with new form tags. Rather than using straight HTML, Fuel has classes for HTML elements that we will use. To open a new form write the following:</p>
			<pre class="brush: php; highlight:[1] notranslate" title="">
				&lt;?php echo Form::open(array(&quot;class&quot;=&gt;&quot;form-horizontal&quot;)); ?&gt;
			</pre>
			<p>This is analogous to writing &#8220;<code>&lt;form class="form-horizontal" action="http://localhost/fuel_intro/public/index.php/comments/create" accept-charset="utf-8" method="post"&gt;</code>&#8221; so it's a good idea to use these HTML elements when possible.</p>
			<p>Next, create a name field for the comment:</p>
			<pre class="brush: php; highlight:[2,3,4,5,6] notranslate" title="">
				&lt;?php echo Form::open(array(&quot;class&quot;=&gt;&quot;form-horizontal&quot;)); ?&gt;
					&lt;fieldset&gt;
						&lt;div class=&quot;form-group&quot;&gt;
							&lt;?php echo Form::label('Name', 'name', array('class'=&gt;'control-label')); ?&gt;
							&lt;?php echo Form::input('name', ''); ?&gt;
						&lt;/div&gt;
			</pre>
			<ul>
				<li><code>Form::label()</code> takes (in order) the text that will be displayed to the user and the id that should match the name attribute of the input field.</li>
				<li><code>Form::input()</code> takes (in order) the name attribute of the form and the default value of that form element.</li>
			</ul>
			<p>You can repeat this code for the comment text as well. The only difference is that instead of <code>Form::input</code>, you'll need to use <code>Form::textarea()</code>, which takes in the same parameters.</p>
			<pre class="brush: php; highlight:[7,8,9,10] notranslate" title="">
				&lt;?php echo Form::open(array(&quot;class&quot;=&gt;&quot;form-horizontal&quot;)); ?&gt;
					&lt;fieldset&gt;
						&lt;div class=&quot;form-group&quot;&gt;
							&lt;?php echo Form::label('Name', 'name', array('class'=&gt;'control-label')); ?&gt;
							&lt;?php echo Auth::instance()-&gt;get_screen_name(); ?&gt;
						&lt;/div&gt;
						&lt;div class=&quot;form-group&quot;&gt;
							&lt;?php echo Form::label('Comment', 'comment', array('class'=&gt;'control-label')); ?&gt;
							&lt;?php echo Form::textarea('comment', Input::post('comment', isset($comment) ? $comment-&gt;comment : ''), array('cols' =&gt; 60, 'rows' =&gt; 8)); ?&gt;
						&lt;/div&gt;
			</pre>
			<p>Did you notice the extra bit of code at the end? The final parameter you can pass for the label, input, or textarea tags is an array of attributes. So when we write &#8220;<code>array('cols' =&gt; 60, 'rows' =&gt; 8));</code>&#8221; at the end of the textarea function,  it's the same as saying &#8220;<code>&lt;textarea cols="60" rows="8"&gt;&lt;/textarea&gt;</code>&#8220;</p>
			<p>Next we just need to add the submit button, a hidden input to keep track of the message this comment is attached to, and close the form:</p>
			<pre class="brush: php; highlight:[11,12,13,14,15,16] notranslate" title="">
				&lt;?php echo Form::open(array(&quot;class&quot;=&gt;&quot;form-horizontal&quot;)); ?&gt;
					&lt;fieldset&gt;
						&lt;div class=&quot;form-group&quot;&gt;
							&lt;?php echo Form::label('Name', 'name', array('class'=&gt;'control-label')); ?&gt;
							&lt;?php echo Auth::instance()-&gt;get_screen_name(); ?&gt;
						&lt;/div&gt;
						&lt;div class=&quot;form-group&quot;&gt;
							&lt;?php echo Form::label('Comment', 'comment', array('class'=&gt;'control-label')); ?&gt;
							&lt;?php echo Form::textarea('comment', Input::post('comment', isset($comment) ? $comment-&gt;comment : ''), array('cols' =&gt; 60, 'rows' =&gt; 8)); ?&gt;
						&lt;/div&gt;
						&lt;div class=&quot;actions&quot;&gt;
							&lt;?php echo Form::hidden('message_id', Input::post('message_id', isset($message) ? $message : '')); ?&gt;
							&lt;?php echo Form::submit('submit', 'Submit', array('class' =&gt; 'btn btn-primary')); ?&gt;
						&lt;/div&gt;
					&lt;/fieldset&gt;
				&lt;?php echo Form::close(); ?&gt;
			</pre>
			<p>Now open up <code>fuel/app/views/comments/create.php</code> and write the following code:</p>
			<pre class="brush: php; highlight:[5,6,7,8] notranslate" title="">
			<ul class="nav nav-pills">
				<li class='<?php echo Arr::get($subnav, "edit" ); ?>'>&lt;?php echo Html::anchor('comments/edit','Edit');?&gt;</li>
				<li class='<?php echo Arr::get($subnav, "create" ); ?>'>&lt;?php echo Html::anchor('comments/create','Create');?&gt;</li>
			</ul>
			&lt;?php $message = isset($message) ? $message : ''; ?&gt;
			&lt;h2 class=&quot;first&quot;&gt;New Comment&lt;/h2&gt;
			&lt;?php echo $form; ?&gt;
			&lt;p&gt;&lt;?php echo Html::anchor('messages/view/'.$message, 'Back'); ?&gt;&lt;/p&gt;
			</pre>
			<p>This bit of code does the following:</p>
			<ul>
				<li>If the message variable doesn't exist, set it to an empty string.</li>
				<li>Print out the form to the screen.</li>
				<li>Create an anchor tag to take us back to the message.</li>
			</ul>

			<p>Go to <a href="http://localhost/fuel_intro/public/comments/create/">http://localhost/fuel_intro/public/comments/create/</a> and take a look at the form. You should see this:</p>
			<p><img src="assets/images/controlling_the_power_01.jpg" alt="A Google Chrome window displaying the create page." /></p>

			<h5 id="Modeling">Modeling</h5>
			<p>This is the easy part of the tutorial. All you need to do is run the following in the command line for oil to use (make sure the model name is singular!):</p>
			<p><code>php oil generate model comment name:string comment:text message_id:int</code></p>

			<div class="os-switch">
				<div class="windows">
					<p><img src="assets/images/modeling_01.jpg" alt="Running php oil generate model comment name:string comment:text message_id:int" /></p>
				</div>
				<div class="linux">
					<p><img src="assets/images/modeling_01.png" alt="Running php oil generate model comment name:string comment:text message_id:int" /></p>
				</div>
				<div class="mini-os-switch">
					Showing Instructions for: <div class="os-button show-linux">Linux/OSX</div> or <div class="os-button show-windows">Windows</div>
				</div>
			</div>

			<p>This command created comment.php in the <code>fuel/app/classes/model</code> folder. If you open up the file you should see this:</p>
			<pre class="brush: php; notranslate" title="">
				&lt;?php

				class Model_Comment extends \Orm\Model
				{
					protected static $_properties = array(
						'id',
						'name',
						'comment',
						'message_id',
						'created_at',
						'updated_at',
					);

					protected static $_observers = array(
						'Orm\Observer_CreatedAt' =&gt; array(
							'events' =&gt; array('before_insert'),
							'mysql_timestamp' =&gt; false,
						),
						'Orm\Observer_UpdatedAt' =&gt; array(
							'events' =&gt; array('before_update'),
							'mysql_timestamp' =&gt; false,
						),
					);

					protected static $_table_name = 'comments';

				}
			</pre>
			<h5 id="Why_Its_So_Small">Why It's So Small</h5>
			<p>Notice that there's not much code there? That's because the comment model extends a class called ORM, or the Object-relational mapper. You can take a look at <a href="http://fuelphp.com/docs/packages/orm/creating_models.html">some of the more complicated things ORM can do</a>, but for now we're just going to stick to the defaults.</p>
			<p>Since we made another model, we're going to have to migrate to the newest version:</p>

			<div class="os-switch">
				<div class="windows">
					<p><img src="assets/images/migra_wha_02.jpg" alt="Running php oil refine migrate" /></p>
				</div>
				<div class="linux">
					<p><img src="assets/images/migra_wha_02.png" alt="Running php oil refine migrate" /></p>
				</div>
				<div class="mini-os-switch">
					Showing Instructions for: <div class="os-button show-linux">Linux/OSX</div> or <div class="os-button show-windows">Windows</div>
				</div>
			</div>

			<p class="note">Quick Note: If an error is encountered when migrating, you can fix any typos in your migration file by going to <code>/fuel/app/migrations/###_create_NAME.php</code> and editing the file.</p>

			<h5 id="Adding_to_the_Database">Adding to the Database</h5>
			<p>We can now edit the comments controller to actually add our comments to the database. So go ahead and open the <code>/fuel/app/classes/controller/comments.php</code> file.</p>
			<p>First and foremost, an <code>$id</code> variable is going to be taken in, so we need to add that as an attribute to the action_create function:</p>
			<pre class="brush: php; first-line: 13; highlight:[13] notranslate" title="">
				public function action_create($id = null)
				{
					$data[&quot;subnav&quot;] = array('edit'=&gt; 'active');
					$this-&gt;template-&gt;title = 'Comments &amp;raquo; Create';
					$data['form'] = View::forge('comments/_form');
					$this-&gt;template->content = View::forge('comments/create', $data);
				}
			</pre>
			<p>Notice that we are setting the <code>$id</code> to null by default. Now we need to check to make sure that they've completed the form, so we add an if statement:</p>
			<pre class="brush: php; first-line: 13; highlight:[15,16,17] notranslate" title="">
				public function action_create($id = null)
				{
					if (Input::post())
					{
					}

					$data["subnav"] = array('edit'=> 'active');
					$this->template->title = 'Comments &raquo; Create';
					$data['form'] = View::forge('comments/_form');
					$this->template->content = View::forge('comments/create', $data);
				}
			</pre>
			<p>This is using Fuel's Input class, but we could have just as easily used <code>"if ($_POST)</code>&#8221; as well.</p>
			<p>But what about going to the form before submitting?</p>
			<pre class="brush: php; first-line: 13; highlight:[18,19,20,21] notranslate" title="">
				public function action_create($id = null)
				{
					if (Input::post())
					{
					}
					else
					{
						$this->template->set_global('message', $id, false);
					}

					$data["subnav"] = array('edit'=> 'active');
					$this->template->title = 'Comments &raquo; Create';
					$data['form'] = View::forge('comments/_form');
					$this->template->content = View::forge('comments/create', $data);
				}
			</pre>
			<p>This means if they didn't post anything, take the <code>$id</code> and turn it into a variable called <code>$message</code> that the view can use.</p>
			<p>Now we need to build a new comment model in order to save the comment into the database.</p>
			<pre class="brush: php; first-line: 13; highlight:[17,18,19,20,21] notranslate" title="">
				public function action_create($id = null)
				{
					if (Input::post())
					{
						$comment = Model_Comment::forge(array(
							'name' =&gt; Input::post('name'),
							'comment' =&gt; Input::post('comment'),
							'message_id' =&gt; Input::post('message_id'),
						));
					}
					else
					{
						$this-&gt;template-&gt;set_global('message', $id, false);
					}

					$data["subnav"] = array('edit'=> 'active');
					$this->template->title = 'Comments &raquo; Create';
					$data['form'] = View::forge('comments/_form');
					$this->template->content = View::forge('comments/create', $data);
				}
			</pre>
			<p><code>$comment</code> is now an object that has the comment information in it, so we need to try and save the comment:</p>
			<pre class="brush: php; first-line: 13; highlight:[23,24,25] notranslate" title="">
				public function action_create($id = null)
				{
					if (Input::post())
					{
						$comment = Model_Comment::forge(array(
							'name' =&gt; Input::post('name'),
							'comment' =&gt; Input::post('comment'),
							'message_id' =&gt; Input::post('message_id'),
						));

						if ($comment and $comment-&gt;save())
						{
						}
					}
					else
					{
						$this-&gt;template-&gt;set_global('message', $id, false);
					}

					$data["subnav"] = array('edit'=> 'active');
					$this->template->title = 'Comments &raquo; Create';
					$data['form'] = View::forge('comments/_form');
					$this->template->content = View::forge('comments/create', $data);
				}
			</pre>
			<p>&#8216;And' is used here instead of &#8216;&amp;&amp;' because it's part of the <a href="http://fuelphp.com/docs/general/coding_standards.html#comparison_logical">Fuel coding standards</a>.</p>
			<p>If the <code>if</code> statement is successful, it will save the comment to the database, so we should now set a flash to show that to the user. <a href="http://fuelphp.com/docs/classes/session/usage.html#method_set_flash">Session Flashes</a> are for information with a limited lifespan, such as presenting success or failure information.</p>
			<p>So we can set our flash and redirect our user back to the message they were viewing:</p>
			<pre class="brush: php; first-line: 13; highlight:[25,26] notranslate" title="">
				public function action_create($id = null)
				{
					if (Input::post())
					{
						$comment = Model_Comment::forge(array(
							'name' =&gt; Input::post('name'),
							'comment' =&gt; Input::post('comment'),
							'message_id' =&gt; Input::post('message_id'),
						));

						if ($comment and $comment-&gt;save())
						{
							Session::set_flash('success', 'Added comment #'.$comment-&gt;id.'.');
							Response::redirect('messages/view/'.$comment-&gt;message_id);
						}
					}
					else
					{
						$this-&gt;template-&gt;set_global('message', $id, false);
					}

					$data["subnav"] = array('edit'=> 'active');
					$this->template->title = 'Comments &raquo; Create';
					$data['form'] = View::forge('comments/_form');
					$this->template->content = View::forge('comments/create', $data);
				}
			</pre>
			<p>or else we set the flash to say that the comment couldn't be saved:</p>
			<pre class="brush: php; first-line: 13; highlight:[28,29,30,31] notranslate" title="">
				public function action_create($id = null)
				{
					if (Input::post())
					{
						$comment = Model_Comment::forge(array(
							'name' =&gt; Input::post('name'),
							'comment' =&gt; Input::post('comment'),
							'message_id' =&gt; Input::post('message_id'),
						));

						if ($comment and $comment-&gt;save())
						{
							Session::set_flash('success', 'Added comment #'.$comment->id.'.');
							Response::redirect('messages/view/'.$comment-&gt;message_id);
						}
						else
						{
							Session::set_flash('error', 'Could not save comment.');
						}
					}
					else
					{
						$this->template-&gt;set_global('message', $id, false);
					}

					$data["subnav"] = array('edit'=> 'active');
					$this->template->title = 'Comments &raquo; Create';
					$data['form'] = View::forge('comments/_form');
					$this->template->content = View::forge('comments/create', $data);
				}
			</pre>
			<h5 id="Creating_A_Comment_from_A_Message">Creating a Comment from a Message</h5>
			<p>Now we're going to add a link to the <code>view.php</code> file in the messages view, so you can add a comment to any message.</p>
			<p>Go to <code>/fuel/app/views/messages/view.php</code> and add:</p>

			<pre class="brush: php; first-line: 1; highlight:[10] notranslate" title="">
				&lt;p&gt;
					&lt;strong&gt;Name:&lt;/strong&gt;
					&lt;?php echo $message-&gt;name; ?&gt;
				&lt;/p&gt;
				&lt;p&gt;
					&lt;strong&gt;Message:&lt;/strong&gt;
					&lt;?php echo $message-&gt;message; ?&gt;
				&lt;/p&gt;
				&lt;p&gt;&lt;?php echo Html::anchor('comments/create/'.$message-&gt;id, 'Add new Comment'); ?&gt;&lt;/p&gt;
				&lt;?php echo Html::anchor('messages/edit/'.$message-&gt;id, 'Edit'); ?&gt; |
				&lt;?php echo Html::anchor('messages', 'Back'); ?&gt;
			</pre>
			<p>Go on back to <a href="http://localhost/fuel_intro/public/messages">http://localhost/fuel_intro/public/messages</a> and add a comment to one of your messages so we can keep going.</p>
			<h5 id="Now_that_we_have_a_Comment...">Now that we have a Comment&#8230;</h5>
			<p>Since there is a comment in the database now, we can add functions to the controller to manipulate that comment. First off, we need a way to be able to edit that comment in <code>/fuel/app/classes/controller/comments.php</code>.</p>
			<p>The edit function will take in one parameter which is the id of the comment</p>
			<pre class="brush: php; first-line: 6; highlight:[6] notranslate" title="">
				public function action_edit($id = null)
				{
					$data["subnav"] = array('edit'=> 'active');
					$this-&gt;template-&gt;title = 'Comments &amp;raquo; Edit';
					$this-&gt;template-&gt;content = View::forge('comments/edit', $data);
				}
			</pre>
			<p>Now we use the comment model to find the comment, based on its id.</p>
			<pre class="brush: php; first-line: 6; highlight:[8] notranslate" title="">
				public function action_edit($id = null)
				{
					$comment = Model_Comment::find($id);
					$data["subnav"] = array('edit'=> 'active');
					$this-&gt;template-&gt;title = 'Comments &amp;raquo; Edit';
					$this-&gt;template-&gt;content = View::forge('comments/edit', $data);
				}
			</pre>
			<p>The rest of the code is pretty much the same as creating a comment with a few minor tweaks, here it is in bulk:</p>
			<pre class="brush: php; first-line: 6; highlight:[9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,30] notranslate" title="">
				public function action_edit($id = null)
				{
					$comment = Model_Comment::find($id);
					if (Input::post())
					{
						$comment-&gt;name = Input::post('name');
						$comment-&gt;comment = Input::post('comment');
						if ($comment-&gt;save())
						{
							Session::set_flash('success', 'Updated comment #'.$id);
							Response::redirect('messages/view/'.$comment-&gt;message_id);
						}
						else
						{
							Session::set_flash('error', 'Could not update comment #'.$id);
						}
					}
					else
					{
						$this-&gt;template-&gt;set_global('comment', $comment, false);
						$this-&gt;template-&gt;set_global('message', $comment->message_id, false);
					}
					$data["subnav"] = array('edit'=> 'active');
					$this-&gt;template-&gt;title = 'Comments &amp;raquo; Edit';
					$data['form'] = View::forge('comments/_form');
					$this-&gt;template-&gt;content = View::forge('comments/edit', $data);
				}
			</pre>
			<p>The action <code>$comment-&gt;save()</code> updates the comment if it already exists in the database, or adds it if it doesn't.</p>
			<p>Note the global variable <code>$message</code>, which will keep track of the message id.
			<p>Also note the <code>$form</code> variable, which will contain our form.</p>
			<p>All that remains is to fix up the comment edit view. Go ahead and open up <code>fuel/app/views/comments/edit.php</code>. It'll wind up looking like the view for editing messages, with a few differences:
				<pre class="brush: php; highlight:[5,6,7,8,9] notranslate" title="">
					&lt;ul class="nav nav-pills"&gt;
						&lt;li class='&lt;?php echo Arr::get($subnav, "edit" ); ?&gt;'&gt;&lt;?php echo Html::anchor('comments/edit','Edit');?&gt;&lt;/li&gt;
						&lt;li class='&lt;?php echo Arr::get($subnav, "create" ); ?&gt;'&gt;&lt;?php echo Html::anchor('comments/create','Create');?&gt;&lt;/li&gt;
					&lt;/ul&gt;
					&lt;h2&gt;Editing Comment&lt;/h2&gt;
					&lt;br/&gt;
					&lt;?php $message = isset($message) ? $message : ''; ?&gt;
					&lt;?php echo $form; ?&gt;
					&lt;p&gt;&lt;?php echo Html::anchor('messages/view/'.$comment-&gt;message_id, 'Back'); ?&gt;&lt;/p&gt;
				</pre>
				<h6 id="Deletion">Deletion</h6>
				<p>Deleting the comment is just as easy as saving it. Go back to <code>/fuel/app/classes/controller/comments.php</code> and create another action function called delete, and then call <code>$comment-&gt;delete()</code> instead of <code>$comment-&gt;save()</code>. Don't forget to pass the comment id!</p>
				<pre class="brush: php; first-line: 45; highlight:[45,46,47,48,49,50,51,52,53,54,55,56,57,58] notranslate" title="">
					public function action_delete($id)
					{
						$comment = Model_Comment::find($id);
						if ($comment)
						{
							$comment-&gt;delete();
							Session::set_flash('success', 'Deleted comment #'.$id);
						}
						else
						{
							Session::set_flash('error', 'Could not delete comment #'.$id);
						}
						Response::redirect('messages/view/'.$comment->message_id);
					}
			</pre>
			<p>In the next section we aim to accomplish two things: showing the number of comments that a message has and showing the comments in a list when we view the message.</p>
			<h5 id="Number_of_Comments">Number of Comments</h5>
			<p>Open up the messages controller. At this point you should be pretty good at navigating the file tree, so we'll stop giving you paths to things you've seen) and take a look at action_index:</p>
			<pre class="brush: php; first-line: 5; notranslate" title="">
				public function action_index()
				{
					$data[$messages] = Model_Message::find('all');
					$this-&gt;template-&gt;title = &quot;Messages&quot;;
					$this-&gt;template-&gt;content = View::forge('messages/index', $data);
				}
			</pre>
			<p>Pretty simple, it's finding all the messages and sending them to the view. In this statement.  To make things a little more flexible as we add in comments, we're going to put the view and messages into their own variables.</p>
			<p>Go to the top of the function and add this:</p>
			<pre class="brush: php; first-line: 5; highlight:[7,8,10] notranslate" title="">
				public function action_index()
				{
					$messages = Model_Message::find('all');
					$view = View::forge('messages/index', array('messages' =&gt; $messages));
					$this-&gt;template-&gt;title = &quot;Messages&quot;;
					$this-&gt;template-&gt;content = $view;
				}
			</pre>
			<p>Just under the messages array we're going to declare an array called $comment_links, and then loop through the messages:</p>
			<pre class="brush: php; first-line: 5; highlight:[9,10,11,12] notranslate" title="">
				public function action_index()
				{
					$messages = Model_Message::find('all');

					$comment_links = array();
					foreach ($messages as $message)
					{
					}

					$view = View::forge('messages/index', array('messages' =&gt; $messages));
					$this-&gt;template-&gt;title = &quot;Messages&quot;;
					$this-&gt;template-&gt;content = $view;
				}
			</pre>
			<p>We need to retrieve the comments associated with this particular message, so we query the database for comments that match the message's id. So far we have been using models to retrieve information from the database, and we could do that here using the <a href="http://fuelphp.com/docs/packages/orm/crud.html#/find_chaining" ?>Model's query method</a>,  but Fuel also has a DB class that we'd like to show you. </p>
			<pre class="brush: php; first-line: 5; highlight:[12,13,14,15] notranslate" title="">
				public function action_index()
				{
					$messages = Model_Message::find('all');

					$comment_links = array();
					foreach ($messages as $message)
					{
						$query = DB::select()
							-&gt;from('comments')
							-&gt;where('message_id', $message-&gt;id)
							-&gt;execute();
					}

					$view = View::forge('messages/index', array('messages' =&gt; $messages));
					$this-&gt;template-&gt;title = 'Messages';
					$this-template-&gt;content = $view;
				}
			</pre>
			<p>The <code>DB::select()</code> method builds a SQL query to retrieve all the comments. This is analogous to &#8220;<code>SELECT * FROM 'comments' WHERE message_id = $message-&gt;id</code>&#8220;</p>
			<p>Now we just need to count the number of results and add that number to the $comment_links array. To make the message's comments easy to access, we're going to make the comment array key match the message id:</p>
			<pre class="brush: php; first-line: 5; highlight:[12,17,18] notranslate" title="">
				public function action_index()
				{
					$messages = Model_Message::find('all');

					$comment_links = array();
					foreach ($messages as $message)
					{
						$results = DB::select()
							-&gt;from('comments')
							-&gt;where('message_id', $message-&gt;id)
							-&gt;execute();

						$count = count($results);
						$comment_links[$message-&gt;id] = "View | $count Comment(s)";
					}

					$view = View::forge('messages/index', array('messages' =&gt; $messages));
					$this-&gt;template-&gt;title = 'Messages';
					$this-&gt;template-&gt;content = $view;
				}
			</pre>
			<p>Let's pretty up the comment count. We'll use Fuel's Inflector class to automatically pluralize &#8216;Comment&#8216; if the count is 0 or above 1.</p>
			<pre class="brush: php; first-line: 5; highlight:[19,20,21,22,23,24,25,26] notranslate" title="">
				public function action_index()
				{
					$messages = Model_Message::find('all');

					$comment_links = array();
					foreach ($messages as $message)
					{
						$results = DB::select()
							-&gt;from('comments')
							-&gt;where('message_id', $message-&gt;id)
							-&gt;execute();

						$count = count($results);

						if ($count == 0)
						{
							$comment_links[$message-&gt;id] = 'View';
						}
						else
						{
							$comment_links[$message-&gt;id] = $count.' '.Inflector::pluralize('Comment', $count);
						}
					}

					$view = View::forge('messages/index', array('messages' =&gt; $messages));
					$this-&gt;template-&gt;title = 'Messages';
					$this-&gt;template-&gt;content = $view;
				}
			</pre>
			<p>Now we just need to set the <code>$comment_links</code> and <code>$messages</code> variables to the view (which is why we declared <code>$view</code> at the top of the function):</p>
			<pre class="brush: php; first-line: 5; highlight:[29,30,31] notranslate" title="">
				public function action_index()
				{
					$messages = Model_Message::find('all');

					$comment_links = array();
					foreach ($messages as $message)
					{
						$results = DB::select()
							-&gt;from('comments')
							-&gt;where('message_id', $message-&gt;id)
							-&gt;execute();

						$count = count($results);

						if ($count == 0)
						{
							$comment_links[$message-&gt;id] = 'View';
						}
						else
						{
							$comment_links[$message-&gt;id] = $count.' '.Inflector::pluralize('Comment', $count);
						}
					}

					$view = View::forge('messages/index');
					$view-&gt;set('comment_links', $comment_links);
					$view-&gt;set('messages', $messages);
					$this-&gt;template-&gt;title = 'Messages';
					$this-&gt;template-&gt;content = $view;
				}
			</pre>
			<p>Now that we are passing the number of comments to the messages view, we need to modify the html to display it. Go back to the <code>index.php</code> file for the messages view, and change it from this:</p>
			<pre class="brush: php; first-line: 9; nostranslate" title="">
				&lt;li&gt;&lt;?php echo Html::anchor('messages/view/'.$message-&gt;id, 'View'); ?&gt;&lt;/li&gt;
			</pre>
			<p>To this:</p>
			<pre class="brush: php; first-line: 9; highlight:[9] nostranslate" title="">
				&lt;li&gt;&lt;?php echo Html::anchor('messages/view/'.$message-&gt;id, $comment_links[$message-&gt;id]); ?&gt;&lt;/li&gt;
			</pre>
			<p>What we did was modify the &#8220;View&#8221; message link to include the number of comments, if any are present. At the moment, there shouldn't be any.
			</p>
			<p>Now if you go to <a href="http://localhost/fuel_intro/public/messages/">http://localhost/fuel_intro/public/messages/</a> you should see the number of comments each message has.</p>
			<h6 id="Showing_the_Comments">Showing the Comments</h6>
			<p>To actually show the comments for each view, you need to get all the comments associated with a message in the messages controller:</p>
			<pre class="brush: php; first-line: 36; highlight:[40,46,47,48,49,50,51] notranslate" title="">
				public function action_view($id = null)
				{
					is_null($id) and Response::redirect('messages');

					if ( ! $message = Model_Message::find($id))
					{
						Session::set_flash('error', 'Could not find message #'.$id);
						Response::redirect('messages');
					}

					$comments = Model_Comment::find('all', array('where' =&gt; array('message_id' =&gt; $id)));

					$data = array(
						'message' =&gt; $message,
						'comments' =&gt; $comments
					);

					$this-&gt;template-&gt;title = 'Message';
					$this-&gt;template-&gt;content = View::forge('messages/view', $data);
				}
			</pre>
			<p>The second parameter of the <code>find()</code> method defines the options in the query. Here we use it to define the <code>WHERE</code> statement in our query.</p>
			<p>Now all we need to do is show it on the view.php page of the message views:</p>
			<pre class="brush: php; first-line: 5; highlight:[9,10,11,12,13,14,15,16,17,18,19,20,21] notranslate" title="">
				&lt;p&gt;
					&lt;strong&gt;Message:&lt;/strong&gt;
					&lt;?php echo $message-&gt;message; ?&gt;
				&lt;/p&gt;
				&lt;h3&gt;Comments&lt;/h3&gt;
				&lt;ul&gt;
				&lt;?php foreach ($comments as $comment) : ?&gt;
					&lt;li&gt;
						&lt;ul&gt;
							&lt;li&gt;&lt;strong&gt;Name:&lt;/strong&gt; &lt;?php echo $comment-&gt;name; ?&gt;&lt;/li&gt;
							&lt;li&gt;&lt;strong&gt;Comment:&lt;/strong&gt;&lt;br /&gt;&lt;?php echo $comment-&gt;comment; ?&gt;&lt;/li&gt;
							&lt;li&gt;&lt;p&gt;&lt;?php echo Html::anchor('comments/edit/'.$comment-&gt;id, 'Edit'); ?&gt;|
							&lt;?php echo Html::anchor('comments/delete/'.$comment-&gt;id, 'Delete', array('onclick' =&gt; &quot;return confirm('Are you sure?')&quot;)); ?&gt;&lt;/li&gt;
						&lt;/ul&gt;
					&lt;/li&gt;
				&lt;?php endforeach; ?&gt;
				&lt;/ul&gt;
			</pre>
			<p>The final section will deal with logging and and creating users.</p>


			<!--  PART 3 -->
			<hr>
			<h3 id="part3">Part 3 &#8211; Adding a Login System</h3>
			<h4 id="Login_Page_and_User_Creation">Creating Users and Login</h4>
			<p>At this point we've made our messages and comments system. However, we don't want just anyone to be able to edit/delete messages, and it would be nice if messages were associated with some kind of username, so we're going to make a simple and generic user system for our messages.</p>
			<p>First add the &#8216;auth' package to the package list in the config file. That's <code>fuel/app/config/config.php</code>, in case you forgot.</p>
			<pre class="brush: php; first-line: 274; highlight:[276] notranslate" title="">
				'packages'	=&gt; array(
					'orm',
					'auth',
				),
			</pre>
			<p>Then we need to create a controller for our login:</p>
			<p><code>php oil g controller users login logout register</code></p>

			<div class="os-switch">
				<div class="windows">
					<p><img src="assets/images/login_page_and_user_creation_01.jpg" alt="Running php oil controller users login logout register in the command line." /></p>
				</div>
				<div class="linux">
					<p><img src="assets/images/login_page_and_user_creation_01.png" alt="Running php oil controller users login logout register in the command line." /></p>
				</div>
				<div class="mini-os-switch">
					Showing Instructions for: <div class="os-button show-linux">Linux/OSX</div> or <div class="os-button show-windows">Windows</div>
				</div>
			</div>

			<p>Notice that we used <code>g</code> instead of <code>generate</code>. This is just one example of the many short tags that Oil allows you to use.</p>
			<p>Now we need to build the models:</p>
			<p><code>php oil g model user username:string password:string group:int email:string last_login:string login_hash:string profile_fields:string</code></p>

			<div class="os-switch">
				<div class="windows">
					<p><img src="assets/images/login_page_and_user_creation_021.jpg" alt="Running php oil g model user username:string password:string group:int email:string last_login:string login_hash:string in the command line." /></p>
				</div>
				<div class="linux">
					<p><img src="assets/images/login_page_and_user_creation_02.png" alt="Running php oil g model user username:string password:string group:int email:string last_login:string login_hash:string in the command line." /></p>
				</div>
				<div class="mini-os-switch">
					Showing Instructions for: <div class="os-button show-linux">Linux/OSX</div> or <div class="os-button show-windows">Windows</div>
				</div>
			</div>


			<p>The only thing that should be explained on this line is groups. Here's the default group number definitions:</p>
			<dl>
				<dt>
					-1  =</dt>
					<dd>Banned</dd>
					<dt>0 =</dt>
					<dd>Guests</dd>
					<dt>1 =</dt>
					<dd>Users</dd>
					<dt>50 =</dt>
					<dd>Moderators</dd>
					<dt>100 =</dt>
					<dd>Administrators </dd>
				</dl>
				<p>This allows you to check all of your user access in bulk, e.g. restricting access for all users whose group is lower than a specific number.</p>
				<p>Finally, migrate to the new version (using the short tag &#8220;r&#8221; instead of &#8220;refine&#8221;):</p>
				<p><code>php oil r migrate</code></p>

			<div class="os-switch">
				<div class="windows">
					<p><img src="assets/images/login_page_and_user_creation_03.jpg" alt="php oil r migrate" /></p>
				</div>
				<div class="linux">
					<p><img src="assets/images/login_page_and_user_creation_03.png" alt="php oil r migrate" /></p>
				</div>
				<div class="mini-os-switch">
					Showing Instructions for: <div class="os-button show-linux">Linux/OSX</div> or <div class="os-button show-windows">Windows</div>
				</div>
			</div>

				<h5 id="The_Default_Table">The Default Table</h5>
				<p>The auth package defaults to a user table called &#8220;users&#8221; by default, so we don't need to do change any configuration options here. But it's good to know where to find the default table name, and how to change it. The auth package has it's own configurations located within the package directory, the following file defines what the user table is called.</p>
				<p><code>/fuel/packages/auth/config/simpleauth.php</code>:</p>
				<pre class="brush: php; first-line: 36; notranslate" title="">
					/**
					* DB table name for the user table
					*/
					'table_name' =&gt; 'users',
				</pre>
				<p>You can change the setting directly in this file, however the best method to change the user table would be to duplicate the above config and place it in a <code>fuel/app/config/simpleauth.php</code> file.  Fuel will automatically override the default package configuration files with your app's configurations.</p>

				<h5 id="Registration">Registration</h5>
				<p>Now that we have a model, controller, and views, we need to add a link to the registration so people can actually sign up! Since this should be on the top of all the pages, we need to edit the template page for the entire site. So go to <code>/fuel/app/views/template.php</code> and add the following:</p>
				<pre class="brush: php; first-line: 11; highlight:[16,17,18,19,20,21,22,23,24,25,26] notranslate" title="">
					&lt;body&gt;
						&lt;div class="container"&gt;
							&lt;div class="col-md-12"&gt;
								&lt;h1&gt;&lt;?php echo $title; ?&gt;&lt;/h1&gt;
								&lt;hr&gt;
								&lt;?php
									if (isset($user_info))
									{
										echo $user_info;
									}
									else
									{
										$link = array(Html::anchor('users/login', 'Login'), Html::anchor('users/register', 'Register'));
										echo Html::ul($link);
									}
								?&gt;
					&lt;?php if (Session::get_flash('success')): ?&gt;
			</pre>
			<p>This checks to see if a user is logged in (we'll call the object with the user's info in it <code>$user_info</code>), if they're not logged in, then it builds an unordered list that links to a registration page.</p>
			<h5 id="Registration_Model">Registration Model</h5>
			<p>We're going to create the registration form using the model and passing it with the controller. Create a function at the bottom of the user model. It's going to have an empty form called a Fieldset passed into it, which is kind of like a form that has validation attached to it:</p>
			<pre class="brush: php; highlight:[34,35,36] notranslate" title="">
				&lt;?php
				use OrmModel;

				class Model_Message extends Model
				{
					protected static $_properties = array(
						'id',
						'name',
						'message',
						'created_at',
						'updated_at',
					);

					protected static $_observers = array(
						'OrmObserver_CreatedAt' =&gt; array(
							'events' =&gt; array('before_insert'),
							'mysql_timestamp' =&gt; false,
						),
						'OrmObserver_UpdatedAt' =&gt; array(
							'events' =&gt; array('before_save'),
							'mysql_timestamp' =&gt; false,
						),
					);

					public static function validate($factory)
					{
						$val = Validation::forge($factory);
						$val-&gt;add_field('name', 'Name', 'required|max_length[255]');
						$val-&gt;add_field('message', 'Message', 'required');

						return $val;
					}

					public static function populate_register_fieldset(Fieldset $form)
					{
					}

				}
			</pre>
			<p>Now we need to attach fields to this form, and send it back to the controller.</p>
			<pre class="brush: php; first-line: 34; highlight:[36,37,38,39,40,41] notranslate" title="">
				public static function populate_register_fieldset(Fieldset $form)
				{
					$form-&gt;add('username', 'Username:')-&gt;add_rule('required');
					$form-&gt;add('password', 'Choose Password:', array('type'=&gt;'password'))-&gt;add_rule('required');
					$form-&gt;add('password2', 'Re-type Password:', array('type' =&gt; 'password'))-&gt;add_rule('required');
					$form-&gt;add('email', 'E-mail:')-&gt;add_rule('required')-&gt;add_rule('valid_email');
					$form-&gt;add('submit', ' ', array('type'=&gt;'submit', 'value' =&gt; 'Register'));
					return $form;
				}
			</pre>
			<p>The <code>add()</code> function adds a certain field with the field's name, label, and attributes in that order. The <code>add_rule()</code> function adds a validation rule to the field. All the rules available by default can be found <a href="http://fuelphp.com/docs/classes/validation/validation.html#rules_table">here</a>.</p>
			<h5 id="User_Controller_Registration_Function">User Controller Registration Function</h5>
			<p>Now we're going to go to the action_register function within the users controller.</p>
			<p>We are going to change it from this:</p>
			<pre class="brush: php; first-line: 20; notranslate" title="">
				public function action_register()
				{
					$data[&quot;subnav&quot;] = array('register'=&gt; 'active' );
					$this-&gt;template-&gt;title = 'Users &amp;raquo; Register';
					$this-&gt;template-&gt;content = View::forge('users/register', $data);
				}
			</pre>
			<p>To this:</p>
			<pre class="brush: php; first-line: 20; highlight:[20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41] notranslate" title="">
				public function get_register($fieldset = null, $errors = null)
				{
					$data[&quot;subnav&quot;] = array('register'=&gt; 'active' );
					$auth = Auth::instance();
					$view = View::forge('users/register', $data);

					if (empty($fieldset))
					{
						$fieldset = Fieldset::forge('register');
						Model_User::populate_register_fieldset($fieldset);
					}

					$view-&gt;set('reg', $fieldset-&gt;build(), false);
					if ($errors) $view-&gt;set_safe('errors', $errors);
					$this-&gt;template-&gt;title = 'Users &amp;raquo; Register';
					$this-&gt;template-&gt;content = $view;
				}

				public function post_register()
				{
					$fieldset = Model_User::populate_register_fieldset(Fieldset::forge('register'));
				}
			</pre>
			<p>The reason for this fragmentation is that both methods will be more specified in what they do.</p>
			<p>We will use <code>$auth</code> to authenticate users, <code>$view</code> will be the view that will be displayed to the user, and <code>$fieldset</code> will be the fieldset that we're sending to the model. <code>Model_User::populate_register_fieldset($form)</code> just populates the form with the fields.</p>
			<p>If we build the form in the view, we can see how this will work. Go to the user register view and add:</p>
			<pre class="brush: php; first-line: 1; highlight:[7,8] notranslate" title="" id="User_Controller_Registration_Function_Last_Step">
				&lt;ul class=&quot;nav nav-pills&quot;&gt;
					&lt;li class='&lt;?php echo Arr::get($subnav, &quot;login&quot; ); ?&gt;'&gt;&lt;?php echo Html::anchor('users/login','Login');?&gt;&lt;/li&gt;
					&lt;li class='&lt;?php echo Arr::get($subnav, &quot;logout&quot; ); ?&gt;'&gt;&lt;?php echo Html::anchor('users/logout','Logout');?&gt;&lt;/li&gt;
					&lt;li class='&lt;?php echo Arr::get($subnav, &quot;register&quot; ); ?&gt;'&gt;&lt;?php echo Html::anchor('users/register','Register');?&gt;&lt;/li&gt;
				&lt;/ul&gt;
				&lt;p&gt;Register&lt;/p&gt;
				&lt;?php if (isset($errors)) { echo $errors; } ?&gt;
				&lt;?php echo $reg; ?&gt;
			</pre>
			<p>Once you do this, you should see the registration form if you go to <a href="http://localhost/fuel_intro/public/users/register">http://localhost/fuel_intro/public/index.php/users/register</a>.</p>
			<h5 id="Validating_the_Registration">Validating the Registration</h5>
			<p><!-- This section needs cleanup and more clarity --></p>
			<p>Now what happens when someone actually fills out the form? We need to have their registration validated. So we need to repopulate the form field with the values that the user typed in, and then send the whole form and authentication to a validation controller. Insert this into <code>post_register()</code> within your users controller:</p>
			<pre class="brush: php; first-line: 38; highlight:[41,42] notranslate" title="">
				public function post_register()
				{
					$fieldset = Model_User::populate_register_fieldset(Fieldset::forge('register'));
					$fieldset-&gt;repopulate();
					$result = Model_User::validate_registration($fieldset, Auth::instance());
				}
			</pre>
			<p>Your user model now needs to take in the form and authentication, so add these functions to it:</p>
			<pre class="brush: php; first-line: 30; highlight:[29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44] notranslate" title="">
			public static function register(Fieldset $form)
			{
				$form-&gt;add('username', 'Username:')-&gt;add_rule('required');
				$form-&gt;add('password', 'Choose Password', array('type'=> 'password'))-&gt;add_rule('required');
				$form-&gt;add('password2', 'Re-type Password:', array('type' => 'password'))-&gt;add_rule('required');
				$form-&gt;add('email', 'E-mail:')->add_rule('required')-&gt;add_rule('valid_email');
				$form-&gt;add('submit', ' ', array('type' =&gt; 'submit', 'value' =&gt; 'Register'));
				return $form;
			}

			public static function validate_registration(Fieldset $form, $auth)
			{
			}
			</pre>
			<p>Then we need to add a rule to the password field that will ensure that the user has typed in a matching password in the password2 field:</p>
			<pre class="brush: php; first-line: 41; highlight:[43] notranslate" title="">
				public static function validate_registration(Fieldset $form, $auth)
				{
					$form-&gt;field('password')-&gt;add_rule('match_value', $form-&gt;field('password2')-&gt;get_attribute('value'));
				}
			</pre>
			<p>Now we need to create a validation object and set messages to display what we want if the user enters in something incorrectly:</p>
			<pre class="brush: php; first-line: 41; highlight:[44,45,46,47] notranslate" title="">
				public static function validate_registration(Fieldset $form, $auth)
				{
					$form-&gt;field('password')-&gt;add_rule('match_value', $form-&gt;field('password2')-&gt;get_attribute('value'));
					$val = $form-&gt;validation();
					$val-&gt;set_message('required', 'The field :field is required');
					$val-&gt;set_message('valid_email', 'The field :field must be an email address');
					$val-&gt;set_message('match_value', 'The passwords must match');
				}
			</pre>
			<p>For a full explanation of the set message feature, look at <a href="http://fuelphp.com/docs/classes/validation/validation.html#errors">Fuel's documentation on error messages</a>.</p>
			<p>Next, we try to run the validation to see if it passes or fails:</p>
			<pre class="brush: php; first-line: 41; highlight:[49,50,51,52,53,54,55,56] notranslate" title="">
				public static function validate_registration(Fieldset $form, $auth)
				{
					$form-&gt;field('password')-&gt;add_rule('match_value', $form-&gt;field('password2')-&gt;get_attribute('value'));
					$val = $form-&gt;validation();
					$val-&gt;set_message('required', 'The field :field is required.');
					$val-&gt;set_message('valid_email', 'The field :field must be an e-mail address.');
					$val-&gt;set_message('match_value', 'The passwords must match.');

					if ($val-&gt;run())
					{
					}
					else
					{
						$errors = $val-&gt;show_errors();
						return array('e_found' =&gt; true, 'errors' =&gt; $errors);
					}
				}
			</pre>
			<p>So, if the validation doesn't pass, the <code>show_errors()</code> function turns the errors into an HTML list, and we return that and a boolean saying that errors were found.</p>
			<h6 id="What_if_they_Pass">What if they Pass?</h6>
			<p>If the user passes validation, then we get their username, password, and email from the form:</p>
			<pre class="brush: php; first-line: 41; highlight:[51,52,53] notranslate" title="">
				public static function validate_registration(Fieldset $form, $auth)
				{
					$form-&gt;field('password')-&gt;add_rule('match_value', $form-&gt;field('password2')-&gt;get_attribute('value'));
					$val = $form-&gt;validation();
					$val-&gt;set_message('required', 'The field :field is required.');
					$val-&gt;set_message('valid_email', 'The field :field must be an e-mail address.');
					$val-&gt;set_message('match_value', 'The passwords must match.');

					if ($val-&gt;run())
					{
						$username = $form-&gt;field('username')-&gt;get_attribute('value');
						$password = $form-&gt;field('password')-&gt;get_attribute('value');
						$email = $form-&gt;field('email')-&gt;get_attribute('value');
					}
					else
					{
						$errors = $val-&gt;show_errors();
						return array('e_found' =&gt; true, 'errors' =&gt; $errors);
					}
				}
			</pre>
			<p>Try to create the user in the database, and catch any errors if we find them:</p>
			<pre class="brush: php; first-line: 41; highlight:[54,55,56,57,58,59,60,61] notranslate" title="">
				public static function validate_registration(Fieldset $form, $auth)
				{
					$form-&gt;field('password')-&gt;add_rule('match_value', $form-&gt;field('password2')-&gt;get_attribute('value'));
					$val = $form-&gt;validation();
					$val-&gt;set_message('required', 'The field :field is required.');
					$val-&gt;set_message('valid_email', 'The field :field must be an e-mail address.');
					$val-&gt;set_message('match_value', 'The passwords must match.');

					if ($val-&gt;run())
					{
						$username = $form-&gt;field('username')-&gt;get_attribute('value');
						$password = $form-&gt;field('password')-&gt;get_attribute('value');
						$email = $form-&gt;field('email')-&gt;get_attribute('value');
						try
						{
							$user = $auth-&gt;create_user($username, $password, $email);
						}
						catch (Exception $e)
						{
							$error = $e-&gt;getMessage();
						}
					}
					else
					{
						$errors = $val-&gt;show_errors();
						return array('e_found' =&gt; true, 'errors' =&gt; $errors);
					}
				}
			</pre>
			<p>We're going to be nice here and log the user in once they register. So if the <code>$user</code> object is present, we can use the <code>$auth</code> object we passed to log the person in:</p>
			<pre class="brush: php; first-line: 41; highlight:[63,64,65,66] notranslate" title="">
				public static function validate_registration(Fieldset $form, $auth)
				{
					$form-&gt;field('password')-&gt;add_rule('match_value', $form-&gt;field('password2')-&gt;get_attribute('value'));
					$val = $form-&gt;validation();
					$val-&gt;set_message('required', 'The field :field is required.');
					$val-&gt;set_message('valid_email', 'The field :field must be an e-mail address.');
					$val-&gt;set_message('match_value', 'The passwords must match.');

					if ($val-&gt;run())
					{
						$username = $form-&gt;field('username')-&gt;get_attribute('value');
						$password = $form-&gt;field('password')-&gt;get_attribute('value');
						$email = $form-&gt;field('email')-&gt;get_attribute('value');
						try
						{
							$user = $auth-&gt;create_user($username, $password, $email);
						}
						catch (Exception $e)
						{
							$error = $e-&gt;getMessage();
						}

						if (isset($user))
						{
							$auth-&gt;login($username, $password);
						}
					}
					else
					{
						$errors = $val-&gt;show_errors();
						return array('e_found' =&gt; true, 'errors' =&gt; $errors);
					}
				}
			</pre>
			<p>If the login doesn't work, then we create an unordered list and return both that and the errors found array:</p>
			<pre class="brush: php; first-line: 41; highlight:[67,68,69,70,71,72,73,74,75,76,77,78,79] notranslate" title="">
				public static function validate_registration(Fieldset $form, $auth)
				{
					$form-&gt;field('password')-&gt;add_rule('match_value', $form-&gt;field('password2')-&gt;get_attribute('value'));
					$val = $form-&gt;validation();
					$val-&gt;set_message('required', 'The field :field is required');
					$val-&gt;set_message('valid_email', 'The field :field must be an email address');
					$val-&gt;set_message('match_value', 'The passwords must match');

					if ($val-&gt;run())
					{
						$username = $form-&gt;field('username')-&gt;get_attribute('value');
						$password = $form-&gt;field('password')-&gt;get_attribute('value');
						$email = $form-&gt;field('email')-&gt;get_attribute('value');
						try
						{
							$user = $auth-&gt;create_user($username, $password, $email);
						}
						catch (Exception $e)
						{
							$error = $e-&gt;getMessage();
						}

						if (isset($user))
						{
							$auth-&gt;login($username, $password);
						}
						else
						{
							if (isset($error))
							{
								$li = $error;
							}
							else
							{
								$li = 'Something went wrong with creating the user!';
							}
							$errors = Html::ul(array($li));
							return array('e_found' =&gt; true, 'errors' =&gt; $errors);
						}
					}
					else
					{
						$errors = $val-&gt;show_errors();
						return array('e_found' =&gt; true, 'errors' =&gt; $errors);
					}
				}
			</pre>
			<p>We have two more things to do. First, go to <code>post_register()</code> on the users controller and add a check for errors, if there are no errors found, log the user in and redirect to the homepage:</p>
			<pre class="brush: php; first-line: 38; highlight:[43,44,45,46,47,48,49] notranslate" title="">
				public function post_register()
				{
					$fieldset = Model_User::populate_register_fieldset(Fieldset::forge('register'));
					$fieldset-&gt;repopulate();
					$result = Model_User::validate_registration($fieldset, Auth::instance());
					if ($result['e_found'])
					{
						return $this-&gt;get_register($fieldset, $result['errors']);
					}

					Session::set_flash('success', 'User created.');
					Response::redirect('./');
				}
			</pre>
			<p>Second, go to the register view and check for errors:</p>
			<pre class="brush: php; first-line: 7; highlight:[7] notranslate" title="">
				&lt;?php if (isset($errors)){echo $errors;}?&gt;
				&lt;?php echo $reg; ?&gt;
			</pre>
			<p>There, now you should be able to register and be logged in automatically.</p>
			<h6 id="Regular_Logging_In_and_Out">Regular Logging In and Out</h6>
			<p>At this point in the crash course we should be able to give you the code for this and expect you to understand it.</p>
			<p>Add the following within the users controller:</p>
			<pre class="brush: php; first-line: 6; highlight:[8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,29,34,35,36,37] notranslate" title="">
				public function action_login()
				{
					$data[&quot;subnav&quot;] = array('login'=&gt; 'active' );
					$auth = Auth::instance();
					$view = View::forge('users/login', $data);
					$form = Form::forge('login');
					$form-&gt;add('username', 'Username:');
					$form-&gt;add('password', 'Password:', array('type' =&gt; 'password'));
					$form-&gt;add('submit', ' ', array('type' =&gt; 'submit', 'value' =&gt; 'Login'));
					if (Input::post())
					{
						if ($auth-&gt;login(Input::post('username'), Input::post('password')))
						{
							Session::set_flash('success', 'Successfully logged in! Welcome '.$auth-&gt;get_screen_name());
							Response::redirect('messages/');
						}
						else
						{
							Session::set_flash('error', 'Username or password incorrect.');
						}
					}
					$view-&gt;set('form', $form, false);
					$this-&gt;template-&gt;title = 'User &amp;raquo; Login';
					$this-&gt;template-&gt;content = $view;
				}

				public function action_logout()
				{
					$auth = Auth::instance();
					$auth-&gt;logout();
					Session::set_flash('success', 'Logged out.');
					Response::redirect('messages/');
				}
			</pre>
			<p>Don't forget to echo the form in the login view! The code is very similar to <a href="#User_Controller_Registration_Function_Last_Step">the user registration view</a> with the exception of swapping <code>$reg</code> with <code>$form</code>.</p>

			<h5 id="Finishing_Touches">Finishing Touches</h5>
			<p>Let's quickly tidy up some of our code. We just need to add the name of the person making the message (instead of letting them type it in themselves), and give them editing rights to their own posts.</p>
			<p>Go to the _form.php files in both the comments and the messages views and replace the name input field with the user's name.</p>
			<p>In messages, from this:</p>
			<pre class="brush: php; first-line: 4; notranslate" title="">
				&lt;div class=&quot;form-group&quot;&gt;
						&lt;?php echo Form::label('Name', 'name', array('class'=&gt;'control-label')); ?&gt;

							&lt;?php echo Form::input('name', Input::post('name', isset($message) ? $message-&gt;name : ''), array('class' =&gt; 'col-md-4 form-control', 'placeholder'=&gt;'Name')); ?&gt;

				&lt;/div&gt;
			</pre>
			<p>To this:</p>
			<pre class="brush: php; first-line: 4; highlight:[5,6] notranslate" title="">
				&lt;div class=&quot;form-group&quot;&gt;
					&lt;?php echo Form::label('Name', 'name', array('class'=&gt;'control-label')); ?&gt;
					&lt;?php echo Auth::instance()-&gt;get_screen_name(); ?&gt;
				&lt;/div&gt;
			</pre>
			<p>In comments, from this:</p>
			<pre class="brush: php; first-line: 4; notranslate" title="">
				&lt;?php echo Form::label('Name', 'name', array('class'=&gt;'control-label')); ?&gt;
				&lt;?php echo Form::input('name', Input::post('name', isset($comment) ? $comment-&gt;name : '')); ?&gt;
			</pre>
			<p>To this:</p>
			<pre class="brush: php; first-line: 4; highlight:[5] notranslate" title="">
				&lt;?php echo Form::label('Name', 'name', array('class'=&gt;'control-label')); ?&gt;
				&lt;?php echo Auth::instance()-&gt;get_screen_name(); ?&gt;
			</pre>
			<p>Next, in both the message and comment controllers, replace the posted name with the user name in the <code>action_create()</code> function. Change it from this:</p>
			<pre class="brush: php; first-line: 39; notranslate" title="">
				'name' =&gt; Input::post('name'),
			</pre>
			<p>To this:</p>
			<pre class="brush: php; first-line: 39; highlight:[39] notranslate" title="">
				'name' =&gt; Auth::instance()-&gt;get_screen_name(),
			</pre>
			<p>Since we don't have a name input form any more, and the message model is still expecting one, you'll have to remove that old requirement. Head over to the message model and remove the validation check for the name field:</p>
			<pre class="brush: php; first-line: 28; highlight:[28] notranslate" title="">
				$val-&gt;add_field('name', 'Name', 'required|max_length[255]');
			</pre>
			<p>Now, head over to the messages index view. Add a check to see if any of the messages being browsed were created by the current user, and if so enable edit/delete privileges on them. This is actually pretty easy. Just change this:</p>
			<pre class="brush: php; first-line: 10; notranslate" title="">
				&lt;li&gt;&lt;?php echo Html::anchor('messages/edit/'.$message-&gt;id, 'Edit'); ?&gt;&lt;/li&gt;
				&lt;li&gt;&lt;?php echo Html::anchor('messages/delete/'.$message-&gt;id, 'Delete', array('onclick' =&gt; "return confirm('Are you sure?')")); ?&gt;&lt;/li&gt;
			</pre>
			<p>To this:</p>
			<pre class="brush: php; first-line: 10; highlight:[10,11,12,13,14,15,16] notranslate" title="">
				&lt;?php if ($message-&gt;name == Auth::instance()-&gt;get_screen_name()) : ?&gt;
					&lt;li&gt;&lt;?php echo Html::anchor('messages/edit/'.$message-&gt;id, 'Edit'); ?&gt;&lt;/li&gt;
					&lt;li&gt;&lt;?php echo Html::anchor('messages/delete/'.$message-&gt;id, 'Delete', array('onclick' =&gt; "return confirm('Are you sure?')")); ?&gt;&lt;/li&gt;
				&lt;?php endif; ?&gt;
			</pre>
			<p>Since there's also an Edit link inside each message, we need to put a check in the message view as well. This code:</p>
			<pre class="brush: php; first-line: 11; notranslate" title="">
				&lt;?php echo Html::anchor('messages/edit/'.$message->id, 'Edit'); ?&gt; |
				&lt;?php echo Html::anchor('messages/', 'Back'); ?&gt;
			</pre>
			<p>Becomes:</p>
			<pre class="brush: php; first-line: 11; highlight:[11,12,13,14,15,16,17,18] notranslate" title="">
				&lt;?php
				if ($message-&gt;name == Auth::instance()-&gt;get_screen_name())
				{
					echo Html::anchor('messages/edit/'.$message-&gt;id, 'Edit');
					echo ' | ';
				}
				echo Html::anchor('messages', 'Back');
				?&gt;
			</pre>
			<p>We should do the same check for comments. In the message view, find:</p>
			<pre class="brush: php; first-line: 16; notranslate" title="">
				&lt;li&gt;&lt;p&gt;&lt;?php echo Html::anchor('comments/edit/'.$comment-&gt;id.'/'. $message-&gt;id, 'Edit'); ?&gt;|
				&lt;?php echo Html::anchor('comments/delete/'.$comment-&gt;id.'/'.$message-&gt;id, 'Delete', array('onclick' =&gt; "return confirm('Are you sure?')")); ?&gt;&lt;/li&gt;
			</pre>
			<p>And change it to:</p>
			<pre class="brush: php; first-line: 16; highlight:[16,17,18,19] notranslate" title="">
				&lt;?php if ($comment-&gt;name == Auth::instance()-&gt;get_screen_name()) : ?&gt;
					&lt;li&gt;&lt;p&gt;&lt;?php echo Html::anchor('comments/edit/'.$comment-&gt;id.'/'.$message-&gt;id, 'Edit'); ?&gt;|
					&lt;?php echo Html::anchor('comments/delete/'.$comment-&gt;id.'/'.$message-&gt;id, 'Delete', array('onclick'=&gt; "return confirm('Are you sure?')")); ?&gt;&lt;/li&gt;
				&lt;?php endif; ?&gt;
			</pre>
			<p>Now you should be able to register users, log in separately, and only have the ability to edit or delete your own messages and comments!</p>
			<h6 id="This_is_the_Last_Thing_I_promise">This Is the Last Thing, <em>I Promise</em></h6>
			<p>The very last thing we're going to do is to check if the user is logged in. If they are, allow them to make a message or comment.</p>
			<p>Add this code towards the top of the message view:</p>
			<pre class="brush: php; first-line: 9; highlight:[9,10,11] notranslate" title="">
				&lt;?php if (Auth::instance()-&gt;check()) : ?&gt;
					&lt;p&gt;&lt;?php echo Html::anchor('comments/create/'.$message-&gt;id, 'Add new Comment'); ?&gt;&lt;/p&gt;
				&lt;?php endif; ?&gt;
				&lt;h3&gt;Comments&lt;/h3&gt;
				&lt;ul&gt;
			</pre>
			<p>Likewise at the bottom of the message's index view:</p>
			<pre class="brush: php; first-line: 30; highlight:[30,31,32,33,34,35] notranslate" title="">
				&lt;?php
				if (Auth::instance()-&gt;check())
				{
					echo Html::anchor('messages/create', 'Add new Message');
				}
				?&gt;
			</pre>
			<p>Finally, we need to replace the login and registration links at the top of the page with a logout link. Head back over to the template file and make these few changes:</p>
			<pre class="brush: php; first-line: 18; highlight:[24,25,26,27,28,29,31] notranslate" title="">
				if (isset($user_info))
				{
					echo $user_info;
				}
				else
				{
					if (Auth::instance()->check())
					{
						$link = array('Logged in as: '.Auth::instance()->get_screen_name(), Html::anchor('users/logout', 'Logout'));
					}
					else
					{
						$link = array(Html::anchor('users/login', 'Login'), Html::anchor('users/register', 'Register'));
					}
					echo Html::ul($link);
				}
			</pre>
		<p>Now instead of always showing links for logging in or registering, once a user is logged in their name will be displayed along with a link to log out!</p>

		<h4 id="Finished">Finished!</h4>
		<p>Congratulations! You now have a working understanding of Fuel along with this neat little messaging system!</p>
		<p class="footnote">For questions, comments, or suggestions, let us know on Twitter <a href="http://www.twitter.com/techrangers">@Techrangers</a>!</p>
	</div>
</div>

	<div id="foot">
		<ul id="foot-info">
			<li id="first">Copyright &copy; 2011, <a href="mailto:techrangers@ucf.edu">Techrangers</a> &reg;</li>
			<li><a href="http://dl.ucf.edu">Center for Distributed Learning</a></li>
		</ul>
	</div>


<script type='text/javascript' src='assets/js/shCore.js'></script>
<script type='text/javascript' src='assets/js/shBrushPhp.js'></script>
<script type='text/javascript'>
(function(){
	var corecss = document.createElement('link');
	var themecss = document.createElement('link');
	var corecssurl = "assets/css/shCore.css";
	if ( corecss.setAttribute ) {
		corecss.setAttribute( "rel", "stylesheet" );
		corecss.setAttribute( "type", "text/css" );
		corecss.setAttribute( "href", corecssurl );
	} else {
		corecss.rel = "stylesheet";
		corecss.href = corecssurl;
	}
	document.getElementsByTagName("head")[0].insertBefore( corecss, document.getElementById("syntaxhighlighteranchor") );
	var themecssurl = "assets/css/shThemeDefault.css";
	if ( themecss.setAttribute ) {
		themecss.setAttribute( "rel", "stylesheet" );
		themecss.setAttribute( "type", "text/css" );
		themecss.setAttribute( "href", themecssurl );
	} else {
		themecss.rel = "stylesheet";
		themecss.href = themecssurl;
	}
		//document.getElementById("syntaxhighlighteranchor").appendChild(themecss);
		document.getElementsByTagName("head")[0].insertBefore( themecss, document.getElementById("syntaxhighlighteranchor") );
	})();
	SyntaxHighlighter.config.strings.expandSource = '+ expand source';
	SyntaxHighlighter.config.strings.help = '?';
	SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
	SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
	SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
	SyntaxHighlighter.defaults['pad-line-numbers'] = false;
	SyntaxHighlighter.defaults['toolbar'] = false;
	SyntaxHighlighter.all();
</script>
<script type="text/javascript">
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-39116019-1']);
	_gaq.push(['_trackPageview']);

	(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	})();
</script>
</body>
</html>
